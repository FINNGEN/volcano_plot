
<!DOCTYPE html>

<!--//////////////////////////////////////////-->
<!-------------------NOTES---------------------->
<!-----------Work in progress code for FinnGen 
   by Stella Keppo & Nicola Cerioli------------->
<!--//////////////////////////////////////////-->

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Volcano plot</title>

  <script src="https://d3js.org/d3.v6.min.js"></script>
   <script src="https://unpkg.com/d3-v6-tip@1.0.6/build/d3-v6-tip.js"></script>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bumbeishvili/d3-tip-for-v6@4/d3-tip.min.css">

   <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/1.13.0/d3-annotation.min.js"></script>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>

   <script src="https://unpkg.com/simplebar@5.3.3/dist/simplebar.min.js"></script>
   <link rel="stylesheet" href="https://unpkg.com/simplebar@latest/dist/simplebar.css"/>

   <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>

   <script src="./dataFile1.js"></script>
   <script src="./dataFile2.js"></script>
   <script src="./dataFile3.js"></script>

    <!--link to google fonts, Roboto-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" rel="stylesheet">



<style>
/*-----------------------------*/
/*#section{
            width: 100%;
            height: 20vh;
            background-color: rgb(197, 219, 227);
            padding: 10vh 0;
        }*/
.card{
  display: inline-block;
  border: 1px solid #999;
  border-radius: 3px;
  outline: none;
  z-index: 99;
  -webkit-user-select: none;
  text-shadow: 1px 1px #fff;
  background: white;
  width: 10vw;
  height: 90%;
  padding: 2.5%;
  margin-left: 10%;
}
.cardBtn {
  cursor: pointer;
}

input {
  width: 100px;
}
/*------------------------------*/

/*help from https://css-tricks.com/snippets/css/custom-file-input-styling-webkitblink/*/
.custom-file-input::-webkit-file-upload-button {
  visibility: hidden;
}
.custom-file-input::before {
  content: 'Select .tsv';
  display: inline-block;
  border: 1px solid #999;
  border-radius: 3px;
  padding: 8px 10px;
  margin: 0px;
  outline: none;
  white-space: nowrap;
  -webkit-user-select: none;
  cursor: pointer;
  text-shadow: 1px 1px #fff;
}
.custom-file-input:hover::before {
  border-color: black;
}
.custom-file-input:active::before {
  background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
}


/*-------------------------*/
button#downloadSample {
  /*width: 150px;*/
  display: inline-block;
  border: 1px solid #999;
  border-radius: 3px;
  padding: 8px 10px;
  margin: 0px;
  outline: none;
  white-space: nowrap;
  -webkit-user-select: none;
  cursor: pointer;
  text-shadow: 1px 1px #fff;
  background: white;
}
button#downloadSample:hover {
  border-color: black;
}
button#firstSet {
  width: 150px;
  display: inline-block;
  border: 1px solid #999;
  border-radius: 3px;
  padding: 8px 25px;
  margin: 0px;
  outline: none;
  white-space: nowrap;
  -webkit-user-select: none;
  cursor: pointer;
  text-shadow: 1px 1px #fff;
  background: white;
}
button#firstSet:hover {
  border-color: black;
}
/*-------------------------*/

button#download {
  width: 150px;
  display: inline-block;
  border: 1px solid #999;
  border-radius: 3px;
  padding: 8px 25px;
  margin: 0px;
  outline: none;
  white-space: nowrap;
  -webkit-user-select: none;
  cursor: pointer;
  text-shadow: 1px 1px #fff;
  background: white;
}
button#download:hover {
  border-color: black;
}
.downloadImgBtn {
  z-index: 40;
  width: 73px;
  display: inline-block;
  border: 1px solid #999;
  border-radius: 3px;
  padding: 8px 25px;
  margin-top: 4px;
  outline: none;
  white-space: nowrap;
  -webkit-user-select: none;
  cursor: pointer;
  text-shadow: 1px 1px #fff;
  background: white;
}
.downloadImgBtn:hover{
  border: 1px solid black;
}
a#downloadSvg{
  text-decoration: none;
}
a#downloadJpeg{
  text-decoration: none;
}


text.annotation-label {
      font-family: 'Roboto', sans-serif;
      font-size: 0.4em;
      letter-spacing: 0.2px;

      word-wrap: normal;
      width: 20px;
    }

.info{
      font-family: 'Roboto', sans-serif;
      letter-spacing: 0.2px;
      font-weight: lighter;
      font-size: 0.7em;
      line-height: 1.3em; 
      font-smooth: subpixel-antialiased;
    }

text.label{
      visibility: hidden;
      font-family: 'Roboto', sans-serif;
      letter-spacing: 0.2px;
      font-weight: lighter;
      font-size: 0.7em;
      font-smooth: subpixel-antialiased;
      /*disable user selection, courtesy of www.w3docs.com*/
       -webkit-user-select: none;
        -webkit-touch-callout: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

/*------------d3 tooltip styling----------------*/
/*general box and text styling*/
 .d3-tip {
      box-sizing: border-box;
      display: inline;
      max-width: 250px;
      line-height: 1.5;
      padding: 8px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 4px;
      font-size: 1em;
      font-family: 'Roboto', sans-serif;
      font-style: italic;
      font-weight: 400;
      z-index: 99;
}
/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
      box-sizing: border-box;
      display: inline;
      max-width: 250px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      /*content: "\25BC"; unicode symbol*/
      position: absolute;
      text-align: right;
}
/* Style northward tooltips specifically */
.d3-tip.n:after {
      margin: -2px 0 0 0;
      top: 100%;/*triangle vertical position*/
      left: 0;
}

/*----------------button styles---------------*/
#button_styled { 
      font-family: 'Roboto', sans-serif;
      font-size: 0.8em;
      margin-right: 1vw;
      padding: 10px 25px;
      border-style: none;
      border-radius: 5px;
      cursor: pointer;
    }
#button_styled-2 { 
      font-family: 'Roboto', sans-serif;
      font-size: 0.8em;
      margin-right: 1vw;
      padding: 10px 25px;
      border-style: none;
      border-radius: 5px;
      cursor: pointer;
    }
/*text button with arrow on top of the legend block*/
#button_legend { 
      display: block;/*center the text*/
      background: transparent;
      font-family: 'Roboto', sans-serif;
      font-size: 0.8em;
      border-style: none;
      cursor: pointer;
      /*margin-left: auto;
      margin-right: auto;*/
      padding-top: 2vh;
      padding-bottom: 2vh;
    }
/*text button with arrow on top of the legend block*/
.button_collapse {
      display: none;
      background: transparent;
      font-family: 'Roboto', sans-serif;
      font-size: 0.8em;
      border-style: none;
      cursor: pointer;
      padding-top: 2vh;
      padding-bottom: 2vh;
    }
/*unique back button to toggle zoom view and general view*/
#button_back {
      font-family: 'Roboto', sans-serif;
      font-size: 0.8em;
      border-radius: 5px;
      display: none;
      border: 1px solid #999;
      border-radius: 3px;
      padding: 8px 25px;
      background: white;
      margin-right: 2vw; 
      cursor: pointer;
    }
a#button_styled_download { 
      font-family: 'Roboto', sans-serif;
      font-size: 1em;
      margin-right: 1vw;
      padding: 10px 25px;
      border-style: none;
      border-radius: 5px;
    }


/*--------------image download styles----------------*/
/*when download img button is clicked*/
#download-options{
      background-color: rgba(0,0,0,0.7);
      /*animation: fade 0.5s linear 1 normal forwards;*/
      width: 100%;/*make full width*/
      height: 100vh;/*make full height*/
      z-index: 99;
      display: none;/*only show after click event*/
      position: fixed;
      top: 0;
      left: 0;
  }

/*when sample data is clicked*/
#upload-options{
  position: fixed;
  top: 50%;
  width: 100%;
  z-index: 99;
  }

#upload-options-background{
  background-color: rgba(0,0,0,0.7);
      /*animation: fade 0.5s linear 1 normal forwards;*/
      width: 100%;/*make full width*/
      height: 100vh;/*make full height*/
      z-index: 95;
      display: none;/*only show after click event*/
      position: fixed;
      top: 0;
      left: 0;
}

/*cross icon*/
[class^="ico-"]{
      font: normal 1em/1 Arial, sans-serif;
      display: inline-block;
}
.ico-times:before{ content: "\2716"; 
}
.close{
  background: white;
  border-color: transparent;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-left: 2vw;
}
.close:hover{
  cursor: pointer;
  border: 1px solid black;
}
#download-options-inner{
      padding-left: 45vw;
      padding-top: 45vh;
}
#downloadImg-block{
      display: none;
      float: right;/*float right to the chart*/
      position: relative;
      top: 43vw;/*position right below the chart*/
      z-index: 90;
}

#divider-vertical {
  border-left: 1px solid black;
  height: 38vw;
  position: absolute;
  right: 0%;
  margin-top: 5vh;
  margin-left: 50px;
  top: 0
}

/*----------brush column styling-----------------*/
#info-column-wrapper{
max-width: 50vw;
height: 40vw;
/*border-bottom: 0.5px solid black;*/
}

    #info-column {
      width: 40vw;
      float: right;
      max-height: 40vw;/*make same height as chart*/
      white-space: nowrap;/*force text to one line*/
      overflow-y: auto;
      grid-auto-rows: 1fr;
      z-index: 1;
    }
   /*individual columns styling, some need more space than others*/
    #category {
      width: 10vw;
      float: left;
      overflow-x: auto; 
    }
    #phenotype {
      width: 10vw;
      padding-left: 1vw;
      float: left;
      overflow-x: auto;
    }
    #pval {
      width: 5vw;
      padding-left: 1vw;
      float: left;
      overflow-x: auto;
    }
    #beta {
      width: 3vw;
      padding-left: 0.6vw;
      float: left;
      overflow-x: auto;
    }
    #case-control {
      width: 6vw;
      padding-left: 1vw;
      float: left;
      overflow-x: auto;
    }
.simplebar-scrollbar::before {
      background-color: #D0D0D0;
}


/*------------checkbox styling help from W3Schools------------*/
/* Hide the browser's default checkbox */
.h5 input {
  position: absolute;
  opacity: 0;
  cursor: pointer;
  height: 0;
  width: 0;
}
/* Create a custom checkbox */
.checkmark-custom {
  position: absolute;
  /*flexbox works with absolute positioning, just not with the commented-out attributes; use margins instead*/
  /*top: 0;*/
  /*left: 110px;*/
  margin-left: 0.5vw;
  margin-top: -1%;/*offset the box*/
  height: 30px;
  width: 30px;
  border: 0.5px solid;
  background-color: white;
}
/* Create the checkmark/indicator (hidden when not checked) */
.checkmark-custom:after {
  content: "";
  position: absolute;
  display: none;
}
/* Show the checkmark when checked */
.chart-btn-container input:checked ~ .checkmark-custom:after {
  display: block;
}
/* Style the checkmark/indicator */
.chart-btn-container .checkmark-custom:after {
  left: 9px;
  top: 5px;
  width: 5px;
  height: 10px;
  border: solid black;
  border-width: 0 3px 3px 0;
  -webkit-transform: rotate(45deg);
  -ms-transform: rotate(45deg);
  transform: rotate(45deg);
}
/*second unique checkmark*/
.checkmark-custom-2 {
  position: absolute;
  margin-left: 0.5vw;
  margin-top: -1%;/*offset the box*/
  height: 30px;
  width: 30px;
  border: 0.5px solid;
  background-color: white;
}
.checkmark-custom-2:after {
  content: "";
  position: absolute;
  display: none;
}
.chart-btn-container input:checked ~ .checkmark-custom-2:after {
  display: block;
}
.chart-btn-container .checkmark-custom-2:after {
  left: 9px;
  top: 5px;
  width: 5px;
  height: 10px;
  border: solid black;
  border-width: 0 3px 3px 0;
  -webkit-transform: rotate(45deg);
  -ms-transform: rotate(45deg);
  transform: rotate(45deg);
}
/*third unique checkmark*/
.checkmark-custom-3 {
  position: absolute;
  margin-left: 0.5vw;
  margin-top: -1%;/*offset the box*/
  height: 30px;
  width: 30px;
  border: 0.5px solid;
  background-color: white;
}
.checkmark-custom-3:after {
  content: "";
  position: absolute;
  display: none;
}
.chart-btn-container input:checked ~ .checkmark-custom-3:after {
  display: block;
}
.chart-btn-container .checkmark-custom-3:after {
  left: 9px;
  top: 5px;
  width: 5px;
  height: 10px;
  border: solid black;
  border-width: 0 3px 3px 0;
  -webkit-transform: rotate(45deg);
  -ms-transform: rotate(45deg);
  transform: rotate(45deg);
}
/*fourth unique checkmark*/
.checkmark-custom-4 {
  position: absolute;
  margin-left: 0.5vw;
  height: 30px;
  width: 30px;
  background-color: #eee;
}
.checkmark-custom-4:after {
  content: "";
  position: absolute;
  display: none;
}

.chart-btn-container input:checked ~ .checkmark-custom-4:after {
  display: block;
}
.chart-btn-container .checkmark-custom-4:after {
  left: 9px;
  top: 5px;
  width: 5px;
  height: 10px;
  border: solid black;
  border-width: 0 3px 3px 0;
  -webkit-transform: rotate(45deg);
  -ms-transform: rotate(45deg);
  transform: rotate(45deg);
}


/*--------------sections and blocks styling-------------------*/
body {
}
    #chart {
      max-width: 50vw;
      max-height: 100vh;
      padding-bottom: 5vh;
      z-index: 1;
    }

    #chartInner {
    display: inline-block;
    position: relative;
    width: 100%;
    padding-bottom: 100%;
    vertical-align: top;
    overflow: hidden;
    margin-top:2vh;
    }

    #input-btn-block {
      padding-left: 0vw;
    }

/*-------------------------*/
    #input-btn-block-sample {
      padding-left: 0vw;
    }
/*--------------------------*/

   #btn-block {
      width: 45vw;
      float: right;
      padding-top: 5vh;
    }

      #btn-block-2 {
      width: 45vw;
      display: none;
      padding-top: -5vh;
    }

    #btn-block-toggle{
      display: block;
    }

    #headline-block {
      padding-left: 7vw;
      padding-top: 3vh;
    }

    #chart-btn-block {
      padding-left: 7vw;
      padding-top: 3vh;
      margin-bottom: -3vh;
      max-height: 100px;
      max-width: 50vw;
    }

    #labels-block{
      position: absolute;
      display: inline-block;
      left: 50vw;
      opacity: 0;
      background: white;
      z-index: 90;
      height: 40vw;
      border: 0px solid black;
      /*box-shadow: inset 0px 0px 0px 0.5px black;*/
      box-sizing: border-box;
      width: 5vw;
      float: left;
      /*border-radius: 0px 10px 10px 0px;*/
    }

    #gLegContainer{
      padding-left: 1.5vw;
      height: 38vw;
      overflow: visible;
    }
      /*.labels-block-outer{
      background: white;
      border: 0px solid black;
      box-shadow: inset 0px 0px 0px 0.5px black;
      box-sizing: border-box;
      width: 50vw;
      float: right;
      height: 50vw;
      margin-top: 140px;
      border-radius: 0px 10px 10px 0px;
    }*/

    #legendTextDiv{
      visibility: visible;
      max-width: 35vw;
    }

    .flexbox-checkbox {
      display: flex;
      flex-direction: row;
      max-width: 50vw;
    }

    .chart-btn-container {
      display: block;
      position: relative;
    }

#hideThese {
      display: block;
}
#ZoomHull {
      display: none;
}

input[type=number] {
    width: 100px;
    padding: 5px 10px;
    box-sizing: border-box;
    border: 0.5px solid black;
  }

  #customCase-block {
    display: none;
  }

  #inputSet {
    font-family: 'Roboto', sans-serif;
    background: white;
      font-size: 0.8em;
      margin-left: 0px;
      padding: 5px 10px;
      border: 0.5px solid black;
      border-radius: 0px;
      cursor: pointer;
  }

  #inputReset{
    font-family: 'Roboto', sans-serif;
    background: white;
      font-size: 0.8em;
      margin-left: 0px;
      padding: 5px 10px;
      border: 0.5px solid black;
      border-radius: 0px;
      cursor: pointer;
  }

/*----------general html tag stylings----------*/
h1{
  font-family: 'Roboto', sans-serif;
  font-size: 3em;
}
.h2 {
  font-family: 'Roboto', sans-serif;
  font-weight: bold;
  font-size: 1.2em;
  color:  #606060;
}
h3{
  font-family: 'Roboto', sans-serif;
  font-size: 1.5em;
}
h4{
  font-family: 'Roboto', sans-serif;
  font-size: 1em;
  margin-bottom: -0.3em;
}
.h5 {
  font-family: 'Roboto', sans-serif;
  font-weight: lighter;
  font-size: 0.8em;
}
p{
  font-family: 'Roboto', sans-serif;
  line-height: 1.5em;
  font-size: 0.9em;
  padding-bottom: 1vh;
}

</style>

</head>

<body>

<div style="max-height:100vh; padding-left:10vw; padding-right: 10vw; padding-top: 3vh; padding-bottom: 2vh;">
  <h1>Welcome.</h1>
  <h3>Here's a few instruction to get the most out of the volcano plot tool. To get started, select a tsv file downloaded from PheWeb.</h5>

<div style="width: 40vw;">
  <h4>Datapoint selection</h4>
  <p>Brush through the datapoints by drawing a rectangle anywhere on the chart. You can reset the brush by clicking anywhere on the chart. To clear out the selection column on the right, press 'clear selection'.</p>

  <h4>Filtering with categories</h4>
  <p>You can highlight datapoints in any category by hovering over the legends next to the chart. The legends represent the categories of the datapoints above the significance line.</p>

  <h4>Zooming</h4>
  <p>Inspect your own selection by drawing a rectangle anywhere on the chart and pressing enter.</p>


  <h4>Marking the points</h4>
  <p>Mark interesting data points by clicking them and move the label around by dragging it. Reset the labels by double-clicking any of the points.</p>
</div>
</div>



<hr size="1" width="100%" color="black"> 

<!-----buttons regarding the information table---->
<div style="position: relative;">
<div id="btn-block">    

  <!--clear selection button-->
  <div id="btn-block-toggle">
        <button id="button_styled" onClick="removeText();removeBrush();removeBrush2();removeBrush3();">Clear selection</button>
        <a id="button_styled_download" download><button id="button_styled" onClick="downloadCsv();">Download table</button></a>
   </div>
  <!-----hide this duplicate block initially---->
<div id="btn-block-2">    
    <!--clear selection duplicate button, don't clear out selection 2-->
        <button id="button_styled-2" onClick="removeText();removeBrush2();removeBrush3();">Clear selection</button>
        <a id="button_styled_download_zoom" download><button id="button_styled" onClick="downloadCsvZoom();">Download table</button></a>
 </div>
 
 <div id="info-column-wrapper">
  <div data-simplebar id="info-column">
    <div data-simplebar id="category">
        <h5 class="h5" style="width: 10vw;">Category</h5>
    </div>
    <div data-simplebar id="phenotype">
        <h5 class="h5" style="width: 10vw;">Phenotype</h5>
    </div>
    <div data-simplebar id="pval">
        <h5 class="h5" style="width: 5vw;">P-value</h5>
    </div>
    <div data-simplebar id="beta">
        <h5 class="h5" style="width: 3vw;">Beta</h5>
    </div>
    <div data-simplebar id="case-control">
        <h5 class="h5" style="width: 5vw;">Cases/Controls</h5>
  </div>
  </div>

   <div id="labels-block">
    <div id="divider-vertical"></div>
    <div id="labels-block-2">
       <button id="button_legend">Show legend &#x1F862;</button>
       <button class="button_collapse" id="buttonCollapse">&#x1F860; Collapse</button>
    </div>
  </div>

</div>



</div>
</div>

<!--relative position to the parent div to enable legends block on the side of the chart to sit with absolute positioning (positioned absolute to be able to sit on top of the information table)-->

  <div id="chart">

  <div id="headline-block"></div>

  <div id="chart-btn-block">
        <div class="chart-btn-container">
        <div class="flexbox-checkbox">
        <!--toggle back and input buttons on zoom vs regular view-->
        <div id="hideThese">
          <div id="input-btn-block">
          <input id="data-file" type="file" class="custom-file-input"/>
           <button id="downloadSample" onClick="showSampleSets()">Use sample data</button>
          </div>
        </div>
        <button id="button_back">Go back</button>
        <div id="ZoomHull">
              <label class="h5">Convex hulls
                    <input type="checkbox" id="hullCheckboxZoom">
                    <span class="checkmark-custom"></span>
              </label>
        </div>
        <div id="hullCheckboxDiv" style="margin-top:1%">
              <label class="h5" style="padding-left: 1vw";>Convex hulls
                    <input type="checkbox" id="hullCheckbox">
                    <span class="checkmark-custom" id="hullCheckMark"></span>
              </label>
        </div>
        <div id="significanceCheckboxDiv" style="margin-top:1%">
              <label class="h5" style="padding-left: 3vw;">Significant
                    <input type="checkbox" id="significanceCheckbox" >
                    <span class="checkmark-custom-2"></span>
              </label>
        </div>
        <div id="pipCheckboxDiv" style="margin-top:1%">
              <label class="h5" style="padding-left: 3vw;">PIP: > 0
                    <input type="checkbox" id="pipCheckbox" >
                    <span class="checkmark-custom-3"></span>
              </label>
              <!--<label class="h5" style="padding-left: 3vw;">Zoom to selection by pressing enter.</label>-->
        </div>


</div><!--end of checkbox flex--> 
</div><!--end of chart btn block-->
</div><!--end of chart btn container-->


<div id="downloadImg-block">
<button id="download" onClick="downloadImg();myToggle()">download image</button>
</div>


<div id="chartInner">
<div id="customCase-block" style="padding-left: 7vw;">
    <label class="h5" for="customCase">Set a custom maximum for scaling case numbers:</label>
    <input type="number" id="customCase" name="customCase">
    <button id="inputSet" onclick="customCaseNumber();">Set</button>
    <button id="inputReset" onclick="customCaseNumberReset();">Reset</button>
</div>
</div>


</div><!--end of chart-->
</div>

  <div id="download-options">
    <div id="download-options-inner">
    <a id="downloadSvg" download="LAVAA_volcano.svg">
      <button class="downloadImgBtn" onClick="hideDownloadOptions()">svg</button>
    </a>
    <a id="downloadJpeg" download="LAVAA_volcano">
      <button class="downloadImgBtn" onClick="hideDownloadOptions()">jpeg</button>
    </a>
    <button class="close" id="closeBtn" onClick="hideDownloadOptions()">
      <i class="ico-times" role="img" aria-label="Cancel"></i>
    </button>
  </div>
  </div>

  <div id="upload-options-background">
    <div id="upload-options"></div><!---container for sample data cards----->
  </div>

  <script>


/////////////////////--csv download--///////////////////////////

        const fileUpload = document.getElementById("data-file")
        fileUpload.onchange = () => {
            const reader = new FileReader();
            const dataFile = fileUpload.files[0]
            var fileInput = document.getElementById('data-file');
            var filename = fileInput.files[0].name;
            reader.readAsText(dataFile, "UTF-8")
            reader.onload = () => {
              const data = reader.result.split("\r\n").slice(1).map(e => {
                const values = e.split("\t");
                return {
                  "phenocode": values[0],
                  "phenostring": values[1],
                  "category": values[2],
                  "pval": parseFloat(values[3]),
                  "beta": parseFloat(values[4]),
                  "maf": parseFloat(values[5]),
                  "maf_case": parseFloat(values[6]),
                  "maf_control": parseFloat(values[7]),
                  "n_case": parseFloat(values[8]),
                  "n_control": parseFloat(values[9]),
                  "pip": parseFloat(values[10]) || 0,
                }
              }).filter(e => e.pval < 1);
              d3.select("#chart").select("svg").remove();
              volcano(data)
                //interactiveLabels();
            }
          } //end of onchange
        const selection2 = []; //an empty array where we can push brushed data
        const selection3 = []; //an empty array where we can push brushed data
        const selection4 = []; //an empty array where we can push brushed data
        function removeText() { //remove texts tagged with 'info' class
          d3.selectAll('p.info').remove();
        }
        function removeBrush() { //remove brush selection
          selection2.length = 0;
        }
        function removeBrush2() { //remove brush selection
          selection3.length = 0;
        }
        function removeBrush3() { //remove brush selection
          selection4.length = 0;
        }
        //show zoom state buttons
        function showBtn() {
          var back = document.getElementById("button_back");
          back.style.display = "block";
          var showZoomHull = document.getElementById("ZoomHull");
          showZoomHull.style.display = "block";
        }
        //hide zoom state buttons
        function hideBtn() {
          var hideBack = document.getElementById("button_back");
          hideBack.style.display = "none";
          var hideZoomHull = document.getElementById("ZoomHull");
          hideZoomHull.style.display = "none";
        }
        //hide normal view buttons on zoom
        function hideBtns() {
          var hide = document.getElementById("hideThese");
          hide.style.display = "none";
          var hideHull = document.getElementById("hullCheckboxDiv");
          hideHull.style.display = "none";
          var hideSig = document.getElementById("significanceCheckboxDiv");
          hideSig.style.display = "none";
          var hidePip = document.getElementById("pipCheckboxDiv");
          hidePip.style.display = "none";
        }
        //show normal view buttons on zoom
        function showBtnBlock() {
          var show = document.getElementById("hideThese");
          show.style.display = "block";
          var showHull = document.getElementById("hullCheckboxDiv");
          showHull.style.display = "block";
          var showSig = document.getElementById("significanceCheckboxDiv");
          showSig.style.display = "block";
          var showPip = document.getElementById("pipCheckboxDiv");
          showPip.style.display = "block";
        }
        //hide download image button, use before image is shown
        function showImgDownload() {
          var show = document.getElementById('downloadImg-block');
          show.style.display = 'block';
          var showCaseBlock = document.getElementById('customCase-block');
          showCaseBlock.style.display = 'block';
        }
        //hide download option buttons
        function hideDownloadOptions() {
          var show = document.getElementById('download-options');
          show.style.display = 'none';
        }
        //show zoom clear selection button
        function showZoomClear() {
          var hide = document.getElementById('btn-block-toggle');
          hide.style.display = 'none';
          var show = document.getElementById('btn-block-2');
          show.style.display = 'block';
        }
        //hide zoom clear selection button
        function hideZoomClear() {
          var show = document.getElementById('btn-block-toggle');
          show.style.display = 'block';
          var hide = document.getElementById('btn-block-2');
          hide.style.display = 'none';
        }
        //toggle download button
        function myToggle() {
          var x = document.getElementById("download-options");
          if(x.style.display === "none") {
            x.style.display = "block";
          } else {
            x.style.display = "none";
          }
        }

        function showLegends() {
          var showL = document.getElementById('labels-block');
          showL.style.opacity = '1';
        }

        function resetDiv(){
              var collapsed = document.getElementById('labels-block')
              collapsed.style.marginRight = '0vw';
              collapsed.style.width = '5vw';
              var showBtn = document.getElementById('button_legend');
              showBtn.style.display = 'block';
              var hideCollapseBtn = document.getElementById('buttonCollapse');
              hideCollapseBtn.style.display = 'none';
              // Get a NodeList of all elements
              const legendTexts = document.querySelectorAll('.label');
              // Change the visibility attr of multiple elements with a loop
              legendTexts.forEach(element => {
                element.style.visibility = 'hidden';
              });
          }



/////////////////////--csv download--///////////////////////////

        function downloadCsv() {
          //function to remove duplicate values from the array
          function removeDuplicates(selection2) {
            return selection2.filter((value, index) => selection2.indexOf(value) === index);
          }
          //make the header
          var data_export_csv_header = Object.keys(selection2[0]).join(), //gets data keys as strings
            rows = removeDuplicates(selection2);
          //this is the core
          data_export_csv_rows = rows.map(function(el) {
              return Object.values(el).join()
            }).join('\n'),
            data_export_csv = data_export_csv_header + '\n' + data_export_csv_rows; //join header and rows
          /*https://riptutorial.com/javascript/example/24711/client-side-csv-download-using-blob*/
          var blob = new Blob([data_export_csv]);
          if(window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveBlob(blob, "tableData.csv");
          } else {
            var a = window.document.createElement("a"); //empty element(link)
            a.href = window.URL.createObjectURL(blob, {
              type: "text/plain"
            });
            //console.log(a.href, 'ciao');
            a.download = "tableData.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }
        }
        function downloadCsvZoom() {
          //function to remove duplicate values from the array
          function removeDuplicates3(selection4) {
            return selection4.filter((value, index) => selection4.indexOf(value) === index);
          }
          //make the header
          var data_export_csv_header = Object.keys(selection4[0]).join(), //gets data keys as strings
            rows = removeDuplicates3(selection4);
          //this is the core
          data_export_csv_rows = rows.map(function(el) {
              return Object.values(el).join()
            }).join('\n'),
            data_export_csv = data_export_csv_header + '\n' + data_export_csv_rows; //join header and rows
          /*https://riptutorial.com/javascript/example/24711/client-side-csv-download-using-blob*/
          var blob = new Blob([data_export_csv]);
          if(window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveBlob(blob, "tableData.csv");
          } else {
            var a = window.document.createElement("a"); //empty element(link)
            a.href = window.URL.createObjectURL(blob, {
              type: "text/plain"
            });
            //console.log(a.href, 'ciao');
            a.download = "tableData.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }
        }


/////////////////////--image download by Nicola--////////////////

        function downloadImg() {
          //show options
          //d3.select("#download-options").style("display","block")
          /* PREPARE SVG DOWNLOAD BUTTON */
          //get svg element.
          var svg = d3.select("#chart").select("svg").node();
          var headline = d3.select("#headline-block").select("text").node();
          console.log(headline)
            //get svg source.
          var serializer = new XMLSerializer();
          var source = serializer.serializeToString(svg);
          //add name spaces.
          if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
            source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
          }
          if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
            source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
          }
          //add xml declaration
          source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
          //convert svg source to URI data scheme.
          var url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
          //set url value to a element's href attribute.
          document.getElementById("downloadSvg").href = url;
          //you can download svg file by right click menu.
          let svgWithBg = d3.select("#chart").select("svg").style("background-color", "white").node()
          var svgString = new XMLSerializer().serializeToString(svgWithBg);
          var DOMURL = self.URL || self.webkitURL || self;
          var img = new Image();
          var svgAbs = new Blob([svgString], {
            type: "image/svg+xml;charset=utf-8"
          });
          var url = DOMURL.createObjectURL(svgAbs);
          img.onload = function() {
            let canvas = document.createElement('canvas')
            canvas.height = 750;
            canvas.width = 799.5;
            var ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, 799.5, 800);
            // var jpg = canvas.toDataURL("image/jpeg",1.0);
            // DOMURL.revokeObjectURL(jpg);
            var image = canvas.toDataURL("image/jpeg", 1.0);
            document.getElementById("downloadJpeg").href = image;
          };
          img.src = url;
        }

  function showSampleSets() {
  var show = document.getElementById('upload-options-background')
  show.style.display = 'block';

  const samples = [
        {
            title:"GCKR",
            description:"UKB Nightingale data",
            data:data1,//taken from the scripts imported above (in head)
        },
        {
            title:"rs1260326",
            description:"description",
            data:data2,
        },
        {
            title:"3_188407204_AC_A",
            description:"description",
            data:data3,
        },
    ];

console.log(data2);
 const sampleblock = d3.select("body")
        .append("div")
        .attr("id","upload-options")
    const cards = sampleblock.selectAll(".cards")
        .data(samples)
        .join("div")
        .classed("card",true)
    cards.append("p")
        .html(d=>d.title)
    cards.append("p")
        .html(d=>d.description);
    cards.append("button")
        .classed("cardBtn", true)
        .html("select")
        .on("click",(e,d)=>{
            const sample = d.data;
            //run your function here
            //  |    |    |    |
            //  V    V    V    V
            volcano(sample)
        });

}

/*Remove both the sample set cards and the background d*/
function hideSampleSets() {
var sampleblock = document.getElementById('upload-options')
  sampleblock.remove();
var background = document.getElementById('upload-options-background')
  background.style.display = 'none';
}

/////////////////////////////////////
function customCaseNumber(){
          var customValue = document.getElementById('customCase').value;
          console.log(customValue);
          const sqrtScale2 = d3.scaleSqrt()
              .domain([0, customValue])
              .range([2, 3]);

          d3.selectAll('#halo')
          .transition()
          .attr('r', d => sqrtScale2(d.n_case));
        }

function customCaseNumberReset(){
  const sqrtScale = d3.scaleSqrt()
              .domain([0, 1000])
              .range([2, 3]);
  d3.selectAll('#halo')
  .transition()
  .attr('r', d => sqrtScale(d.n_case))

  document.getElementById('customCase').value = '';
}



/////////////////////////////////////////////////////
//////----the main function starts here---///////////
/////////////////////////////////////////////////////

        function volcano(data) {
          hideSampleSets();
          showImgDownload();
          hideDownloadOptions();
          hideSampleSets();
          showLegends();
          d3.select('.h2').remove();
          d3.select('#gLegContainer').remove();
          d3.select('#gLegContainer2').remove();

          document.getElementById('button_legend').onclick = function() {
            return expandDiv();
          };
          document.getElementById('hullCheckbox').onclick = function() {
            if(this.checked) {
              if(document.getElementById('significanceCheckbox').checked) {
                return showHull2();
              } else {
                return showHull();
              }
            } else {
              return hideHull();
            }
          };
          document.getElementById('hullCheckboxZoom').onclick = function() {
            if(this.checked) {
              return showHull3();
            } else {
              return hideHull();
            }
          };
          //show and hide convex hull with a checkbox
          document.getElementById('significanceCheckbox').onclick = function() {
            if(this.checked) {
              return redrawScale(); // show significant ones
            } else {
              return overView(); //return to normal state
            }
          };
          //show and hide pip with a checkbox
          document.getElementById('pipCheckbox').onclick = function() {
            if(this.checked) {
              if(document.getElementById('significanceCheckbox').checked) {
                return showPip2();
              } else {
                return showPip();
              } // show nodes with high pip-values
            } else {
              return hidePip(); //hide pip indication
            }
          };

          function expandDiv() {
            var expanded = document.getElementById('labels-block')
            expanded.style.marginRight = '-50vw';
            expanded.style.width = '50vw';
            var hideBtn = document.getElementById('button_legend');
            hideBtn.style.display = 'none';
            var showCollapseBtn = document.getElementById('buttonCollapse');
            showCollapseBtn.style.display = 'block';
            document.getElementById('buttonCollapse').onclick = function() {
                return collapseDiv();
              }
              // Get a NodeList of all elements
            const legendTexts = document.querySelectorAll('.label');
            // Change the visibility attr of multiple elements with a loop
            legendTexts.forEach(element => {
              element.style.visibility = 'visible';
            });

            function collapseDiv() {
              var collapsed = document.getElementById('labels-block')
              collapsed.style.marginRight = '0vw';
              collapsed.style.width = '5vw';
              var showBtn = document.getElementById('button_legend');
              showBtn.style.display = 'block';
              var hideCollapseBtn = document.getElementById('buttonCollapse');
              hideCollapseBtn.style.display = 'none';
              // Get a NodeList of all elements
              const legendTexts = document.querySelectorAll('.label');
              // Change the visibility attr of multiple elements with a loop
              legendTexts.forEach(element => {
                element.style.visibility = 'hidden';
              });
            }
          } //end of expand-collapse


          function goBack() {
            overView();
            showBtnBlock();
          }

          function clearSelections() {
            removeText();
            removeBrush();
            removeBrush2();
            removeBrush3();
          }
          document.getElementById('button_back').onclick = function() {
              return goBack();
            }
          //setting values for the viewBox
          const heightValue = 330;
          const widthValue = 320;
          //Create SVG and padding for the chart
          const svg = d3.select("#chartInner").append("svg")
          .attr("viewBox", `2 -10 320 330`)
          .attr("stroke-width", "0.3");
          const margin = {
            top: 50,
            bottom: 50,
            left: 40,
            right: 2
          };
          const chart = svg.append("g").attr("transform", `translate(${margin.left},0)`);
          const width = 320 - margin.left - margin.right; //width of the chart
          const height = 330 - margin.top - margin.bottom; //height of the chart

          //create an svg for legend container since it's outside of the chart div
          const svg2 = d3.select('#labels-block').append('svg').attr('id', 'gLegContainer')
          //.attr("width", 500).attr("height", height * 2.1); //width and height of the inner svg, doesn't affect the div
          const legendBlockVar = svg2.append('g').attr("transform", `translate(${margin.right},0)`);

          const f = d3.format(".1f");

          //Initiating Y- and color-scales
          var yScale = d3.scaleLog()
          var yScale2 = d3.scaleLog()
          var yScale3 = d3.scaleLog()
          const colorScale = d3.scaleOrdinal().range(d3.schemeTableau10);
          const colorValue = d => d.category; //Color value by category
          const colorScale2 = d3.scaleOrdinal().range(d3.schemeTableau10);
          //getting max and min y (p-value) values
          var max = d3.max(data, function(d) {
            return d.pval;
          });
          var min = d3.min(data, function(d) {
              return d.pval;
            })
            //create two Yscales with different ranges
          yScale.domain([min, max])
            .range([0, height]).nice();
          yScale2.domain([0.0000001, max + 5]) //padding to the bottom
            .range([200, 250]);
          //extra y-scale for showing only significant values
          yScale3.domain([min, 0.0000001]).range([0, height]).nice();
          //getting max and min x (beta) values
          var betaMax = d3.max(data, function(d) {
            return d.beta;
          });
          var betaMin = d3.min(data, function(d) {
            return d.beta;
          });
          //get min and max beta from significant ones
          var betaMax2 = d3.max(data, function(d) {
            if(d.pval <= 0.0000001) {
              return d.beta;
            }
          });
          var betaMin2 = d3.min(data, function(d) {
            if(d.pval <= 0.0000001) {
              return d.beta;
            }
          });
          var biggerBeta = d3.max(data, function(d){
            if(betaMax > betaMin*(-1)){
              return betaMax;
            } else {return betaMin*(-1)}
          })

          //getting max case values
          var CaseMax = d3.max(data, function(d) {
            return d.n_case;
          });

          //create x-scale
          var xScale = d3.scaleLinear().domain([biggerBeta*(-1)-0.1, biggerBeta+0.1]) //make x-scale symmetrical
            .range([0, width]);
          var xScale2 = d3.scaleLinear().domain([betaMin2-0.1, betaMax2+0.1]).range([0, width]);
          //initializing square root scale for scaling datapoint size
          const sqrtScale = d3.scaleSqrt()
          .domain([0, CaseMax])
          .range([2, 20]);


          /*var fileInput = document.getElementById('data-file');
          var filename = fileInput.files[0].name;
          var headline = d3.select('#headline-block')
          var newStr = filename.replace(/_/g, ":");
          headline.append('text').attr("x", 0).attr("y", 0).attr('class', 'h2').text(function(d) {
            return newStr.split('.')[0] //get the filename without the extension
              .slice(0, -23)
          });*/

          //enable the enter-zoom in first state
          //trigger a function with enter. https://stackoverflow.com/questions/40252637/keypress-trigger-a-function-if-specific-pressed
          function checkKey(e) {
            var key = e.which || e.keyCode;
            if(key === 13) {
            zooming();
            showBtn();
            hideBtns();
            removeText(); //on enter zoom, remove old selection text and switch button view
              }
          }
          document.addEventListener("keypress", checkKey);
          //Append the X Axis
          chart.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5).tickSize(-height))
            //adjust tick labels
            .selectAll('text').style('font-size', '0.5em').style('opacity', 0.5);
          //Append the Y Axis
          chart.append("g").attr("transform", `translate(0, 0)`).call(d3.axisLeft(yScale)
            .ticks(5)
              .tickSize(-width))
            //adjust tick labels
            .selectAll('text').attr('class', 'yTickLabel').style('font-size', '0.5em').style('opacity', 0.5)
            .text(function(d) {
              return d === 1 ? d : d.toExponential().replace('1e-', '');
            });
          //add labels
          chart.append("text")
          .text("-log10 p-value")
          .attr("x", 20)
          .attr("y", height / 1.8)
          .attr("transform", "translate(-150,150) rotate(-90)")
          .attr('class', 'axisLabel')
          .style('font-size', '0.4em')
          .style('font-family', 'sans-serif')
          chart.append("text")
          .attr("x", width / 2)
          .attr("y", height * 1.08)
          .attr('class', 'axisLabel')
          .style("text-anchor", "middle")
          .text("beta value")
          .style('font-size', '0.4em')
          .style('font-family', 'sans-serif')
          //lightly color the zero side of the x-axis
          chart.append('rect')
          .attr("height", height)
          .attr('width', xScale(0))
          .attr("fill", "lightgray")
          .attr("opacity", 0.2);
          d3.selectAll('g.tick')
          .select('line')
          .style('stroke-width', 0.1)
          .style('opacity', 0.5);
          chart.append('line')
          .attr("x1", 0)
          .attr("y1", yScale(0.0000001))
          .attr("x2", width)
          .attr("y2", yScale(0.0000001))
          .style("stroke", 'grey')
          .style("stroke-dasharray", ("3, 3"))
          .style("stroke-width", 0.5);
          //set up the tooltip
          var tool_tip = d3.tip().attr("class", "d3-tip").offset([-5, 0]).html((event, d) => {
            return d.category + '<br>' + '<br>' + d.phenostring + '<br>' + '<br>' + "p-value: " + d.pval + "<br>" + "beta value: " + d.beta + '<br>' + "cases / controls: " + d.n_case + ' / ' + d.n_control + '<br>' + 'pip: ' + d.pip
          });
          svg.call(tool_tip);


///////////////////--bigger background dots--//////////////////////

          var g = svg.append('g') //make a new g element to which we append circles
            .attr("id", "dataPoints")
            .selectAll('g').data(data).enter().append('g')
          g.append('circle')
          .attr('id', 'halo')
          .attr("cx", function(d) {
              return xScale(d.beta) + 40;
            }) //+margin-left amount
            .attr("cy", function(d) {
              return yScale(d.pval)
            })
            .attr('r', d => sqrtScale(d.n_case))
            /*.attr('r', function(d){
              if(d.n_case < 1000){
                return sqrtScale(d.n_case);
              } else { return 10;}
            })*/
            .style('pointer-events', 'none') //disable hover effects
            .style('opacity', function(d) {
              if(d.pval >= 0.0000001) {
                return 'opacity', 0.1
              } else {
                return 'opacity', 0.2
              }
            }).attr('fill', d => colorScale(colorValue(d))) //color by category


///////////////////////////--add dots--////////////////////////////

          g.append('circle').attr("cx", function(d) {
              return xScale(d.beta) + 40;
            }) //+margin-left amount
            .attr("cy", function(d) {
              return yScale(d.pval)
            }).attr('fill', d => colorScale(colorValue(d))).attr('class', 'circleCenter').attr('r', 2).attr('stroke', 'white').attr('opacity', function(d) {
              if(d.pval >= 0.0000001) {
                return 'opacity', 0.4
              } else {
                return 'opacity', 1
              }
            }).attr('fill', d => colorScale(colorValue(d)))


////////////////////--hover events--////////////////////////////////

            //tooltip
            .on('mouseover.tip', tool_tip.show, function() {
              d3.select(this).transition().duration('100');
            }).on('mouseout.tip', tool_tip.hide)
            //highlight color
            .on('mouseover.color', function() {
              d3.select(this).transition().duration('200').style('opacity', 1).attr('r', d => sqrtScale(d.n_case))
            }).on('mouseout.color', function() {
              d3.select(this).transition().duration('200').style('opacity', function(d) {
                if(d.pval >= 0.0000001) {
                  return 'opacity', 0.4
                } else {
                  return 'opacity', 1
                }
              }).attr('r', 2)
            })
            //add labels on click, mostly credit to Nicola
            .on("click", function(e, d) {
              var x = parseFloat(d3.select(this).attr("cx")),
                y = parseFloat(d3.select(this).attr("cy"));
              //format the case number with a comma separator
              let format = d3.format(',');
              let formattedCases = format(d.n_case);
              const label = labelLayer.append("g").classed("chartLabel", true).style("transform", `translate(${x+10}px,${y+10}px)`);
              label.append("line")
              .attr("x1", 0)
              .attr("y1", -2.5)
              .attr("x2", -10)
              .attr("y2", -10)
              .style("stroke-width", "0.5px")
              .style("stroke", "#d3d3d3")
              label.append("text")
              .style("font-size", "5px")
              .style("font-family", "sans-serif")
              .style("cursor", "grab")
              .text(d.phenostring)
              .call(d3.drag()

              .on("start", dragLabelStarted))
              //I'm sure this can be worked in another way, but appended an empty string where to append the tspan: empty string allows us to always translate to the correct x-point without worrting anbout the lenght of the first string 
              label.append("text").style("font-size", "5px").style("font-family", "sans-serif").text('').call(d3.drag().on("start", dragLabelStarted))
                //tspan in a separate line
                .append('tspan').style("cursor", "grab").style("font-size", "5px").style("font-family", "sans-serif").attr('dy', '7px').attr('dx', '0px').text('Cases: ' + formattedCases).call(d3.drag().on("start", dragLabelStarted))
            })
            //reset labels on double-click
            .on('dblclick', function() {
              labelLayer.selectAll("*").remove();
            });


//////////////////////--labels--//////////////////////////////////////

          newData = data.filter(d => d.pval <= 0.0000001)
            //categoryData = data.filter(d => d.category == 'Diseases marked as autimmune origin')
            //https://wsvincent.com/javascript-remove-duplicates-array/, this method found from the chat belove the post
          const unique = [];
          newData.map(x => unique.filter(a => a.category == x.category && a.category == x.category).length > 0 ? null : unique.push(x));
          //Initialize data
          var chartData = unique;
          //Initialize legend
          var clicked = ""
          var legendItemSize = 8;
          var legendSpacing = 20;
          var xOffset = 10;
          var yOffset = 10;
          //var labelsBlock = d3.select('#labels-block')
          var gLeg = legendBlockVar.selectAll('g').data(chartData).enter().append('g')
          gLeg.append('circle').style('fill', d => colorScale(colorValue(d))).attr('r', legendItemSize).attr('transform', (d, i) => {
            var x = xOffset;
            var y = yOffset + (legendItemSize + legendSpacing) * i;
            return `translate(${x}, ${y})`;
          })
          gLeg.append('text').attr('class', 'label').attr('x', xOffset + legendItemSize + 5).attr('y', (d, i) => yOffset + (legendItemSize + legendSpacing) * i + 5).text(d => d.category)
            ////////////////////////////////////////////////////////////////////
            //attaching click to the legend text for now
          gLeg.on("mouseover.legend", function(d) {
              d3.selectAll('.newCircleCenter').remove();
              var legendText = this.textContent; //get the text of the legend in a variable
              var HighlightData = data.filter(d => d.category == legendText) //get the data objects associated with the legend
              d3.selectAll('.circleCenter').style('opacity', 0.1) //on any click set all centers to hidemode
                //.style('pointer-events', 'none')
                //Append new circles
              var g = svg.append('g').selectAll('g').data(HighlightData).enter().append('g')
              g.append('circle').attr("cx", function(d) {
                  return xScale(d.beta) + 40;
                }).attr("cy", function(d) {
                  return yScale(d.pval)
                }).attr('fill', d => colorScale(colorValue(d)))
                .attr('class', 'newCircleCenter')
                .attr('r', 2)
                .attr('stroke', 'white')
                .attr('opacity', 1)
                .attr('fill', d => colorScale(colorValue(d)))
                //tooltip
                .on('mouseover.tip', tool_tip.show, function() {
                  d3.select(this).transition().duration('100');
                }).on('mouseout.tip', tool_tip.hide)
                //highlight color
                .on('mouseover.color', function() {
                  d3.select(this).transition().duration('200').style('opacity', 1).attr('r', d => sqrtScale(d.n_case))
                }).on('mouseout.color', function() {
                  d3.select(this).transition().duration('200').style('opacity', 1).attr('r', 2)
                })
                //add labels on click, mostly credit to Nicola
                .on("click", function(e, d) {
                  var x = parseFloat(d3.select(this).attr("cx")),
                    y = parseFloat(d3.select(this).attr("cy"));
                  //format the case number with a comma separator
                  let format = d3.format(',');
                  let formattedCases = format(d.n_case);
                  const label = labelLayer.append("g").classed("chartLabel", true).style("transform", `translate(${x+10}px,${y+10}px)`);
                  label.append("line").attr("x1", 0).attr("y1", -2.5).attr("x2", -10).attr("y2", -10).style("stroke-width", "0.5px").style("stroke", "#d3d3d3")
                  label.append("text").style("font-size", "5px").style("font-family", "sans-serif").style("cursor", "grab").text(d.phenostring).call(d3.drag().on("start", dragLabelStarted))
                    //I'm sure this can be worked in another way, but appended an empty string where to append the tspan: empty string allows us to always translate to the correct x-point without worrting anbout the lenght of the first string 
                  label.append("text").style("font-size", "5px").style("font-family", "sans-serif").text('').call(d3.drag().on("start", dragLabelStarted))
                    //tspan in a separate line
                    .append('tspan').style("cursor", "grab").style("font-size", "5px").style("font-family", "sans-serif").attr('dy', '7px').attr('dx', '0px').text('Cases: ' + formattedCases).call(d3.drag().on("start", dragLabelStarted))
                })
                //reset labels on double-click
                .on('dblclick', function() {
                  labelLayer.selectAll("*").remove();
                });
              //highlight selected gLeg group
              d3.selectAll(gLeg).style('opacity', 0.5)
              d3.select(this).style('opacity', 1);
            }) //end of click
            //double-click anywhere on the labels block
          var labelsBlock = d3.select('#labels-block')
          labelsBlock.on('mouseout.legend', function(d) {
              //reset circlecenter opacity
              d3.selectAll('.circleCenter').style('opacity', function(d) {
                  if(d.pval >= 0.0000001) {
                    return 'opacity', 0.4
                  } else {
                    return 'opacity', 1
                  }
                })
                //remove highlights
              d3.selectAll('.newCircleCenter').remove();
              //legend items back to full opacity
              d3.selectAll(gLeg).style('opacity', 1);
            })


//////////////////////--brushing--/////////////////////////

            //help from https://peterbeshai.com/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/
            //const selection2 = [];//an empty array where we can push data
          const brush = d3.brush().extent([
            [0, 0],
            [width, height]
          ]); //stay within the chart and above the significance
          //attach the brush to the chart
          const gBrush = chart.append('g').attr('class', 'brush').call(brush);
          //column setup for the brushed data
          const table = d3.select('#info-column');
          const categoryCol = d3.select('#category');
          const phenoCol = d3.select('#phenotype');
          const pvalCol = d3.select('#pval');
          const betaCol = d3.select('#beta');
          const caseCol = d3.select('#case-control');
          //brush event
          brush.on('end', function(event, d) {
            const selection = event.selection; //the scope of the brush
            d3.selectAll('circle').each(function(d) { //go through the points
                if(yScale(d.pval) > selection[0][1] && yScale(d.pval) < selection[1][1] && xScale(d.beta) > selection[0][0] && xScale(d.beta) < selection[1][0]) {
                  selection2.push(d) //push data to the empty array
                }
              })
              //function to remove duplicate values from the array
            function removeDuplicates(selection2) {
              return selection2.filter((value, index) => selection2.indexOf(value) === index);
            }
            //console.log(removeDuplicates(selection2))
            categoryCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
              return i * 12;
            }).attr('margin-top', function(d, i) {
              if('overflow-x' == true) {
                return -3;
              }
            }).html(function(d) {
              return d.category;
            })
            phenoCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').attr('id', 'row').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
              return i * 12;
            }).html(function(d) {
              return d.phenostring;
            })
            pvalCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
              return i * 12;
            }).html(function(d) {
              return d.pval;
            })
            betaCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
              return i * 12;
            }).html(function(d) {
              return d.beta;
            })
            caseCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
              return i * 12;
            }).html(function(d) {
              return d.n_case + ' / ' + d.n_control;
            })
          });


/////////////////////--convex hull--////////////////////////////////

          function showHull() { // wrapped the hull in a function
            //convex hull code by Nicola
            var hullPoints = []; //create empty array where to store datapoints
            const groups = d3.groups(data, function(d) {
              return d.category; //grouping done by categories, returns an array
            }).filter(function(G) {
              const groupsize = G[1].filter(function(g) {
                return g.pval < 0.0000001;
              }).length;
              if(groupsize > 0) {
                return G;
              }
            })
            groups.forEach(e => {
              const group = e[1]
              group.forEach((d, i) => {
                hullPoints[i] = [xScale(d.beta) + 40, yScale(d.pval)]
              })
              const hull = d3.polygonHull(hullPoints)
              const color = colorScale(e[0])
              if(hull) {
                svg.append("path").attr('class', 'hullPath').attr("d", "M" + hull.join("L") + "Z") //generates the line; M-moveto a specific point, L-lineto a specificpoint, Z-closepath. hull joined by a lineto
                  .attr("stroke", color).attr("stroke-width", 0.25).attr("fill", color).attr("fill-opacity", 0.1).style('pointer-events', 'none') //disable hover effects
              }
              hullPoints = [] //refresh the array
            })
          }


/////////////////////--convex hull 2--////////////////////////////////

          function showHull2() {
            var hullPoints = []; //create empty array where to store datapoints
            const groups = d3.groups(newData, function(d) {
                return d.category; //grouping done by categories, returns an array
              })
              //convex hull code by Nicola
            groups.filter(function(G) {
              const groupsize = G[1].filter(function(g) {
                return g.pval < 0.0000001;
              }).length;
              if(groupsize > 0) {
                return G;
              }
            }).forEach(e => {
              const group = e[1]
              group.forEach((d, i) => {
                if(d.pval <= 0.0000001) {
                  hullPoints[i] = [xScale2(d.beta) + 40, yScale3(d.pval)]
                }
              })
              const hull = d3.polygonHull(hullPoints)
              const color = colorScale(e[0])
              if(hull) {
                svg.data(hull).append("path").attr('class', 'hullPath').attr("d", "M" + hull.join("L") + "Z") //generates the line; M-moveto a specific point, L-lineto a specificpoint, Z-closepath. hull joined by a lineto
                  .attr("stroke", color).attr("stroke-width", 0.25).attr("fill", color).attr("fill-opacity", 0.1).style('pointer-events', 'none') //disable hover effects
              }
              hullPoints = [] //refresh the hullpoints array in the end of the loop
            })
          }


/////////////////////--convex hull 3 for zoom--///////////////////

          function showHull3() {
            //get min and max p values from selection for zooming
            var pMax2 = d3.max(selection2, function(d) {
              return d.pval;
            });
            var pMin2 = d3.min(selection2, function(d) {
              return d.pval;
            })
            var yScale4 = d3.scaleLog().domain([pMin2 - (pMin2 / 1.001), pMax2 + (pMax2 * 2)]).range([0, height]).nice();
            //get min and max beta from selection for zooming
            var betaMax3 = d3.max(selection2, function(d) {
              return d.beta;
            });
            var betaMin3 = d3.min(selection2, function(d) {
              return d.beta;
            });
            var xScale3 = d3.scaleLinear()
              //.domain([betaMin3-(betaMax3),betaMax3+(betaMin3*(-1))])
              .domain([betaMin3-0.1, betaMax3+0.1]).range([0, width]);
            var hullPoints = []; //create empty array where to store datapoints
            const groups = d3.groups(selection2, function(d) {
                return d.category; //grouping done by categories, returns an array
              })
              //convex hull code by Nicola
            groups.filter(function(G) {
              const groupsize = G[1].filter(function(g) {
                return g.pval < 0.0000001;
              }).length;
              if(groupsize > 0) {
                return G;
              }
            }).forEach(e => {
              const group = e[1]
              group.forEach((d, i) => {
                hullPoints[i] = [xScale3(d.beta) + 40, yScale4(d.pval)]
              })
              const hull = d3.polygonHull(hullPoints)
              const color = colorScale(e[0])
              if(hull) {
                svg.data(hull).append("path").attr('class', 'hullPath').attr("d", "M" + hull.join("L") + "Z") //generates the line; M-moveto a specific point, L-lineto a specificpoint, Z-closepath. hull joined by a lineto
                  .attr("stroke", color).attr("stroke-width", 0.25).attr("fill", color).attr("fill-opacity", 0.1).style('pointer-events', 'none') //disable hover effects
              }
              hullPoints = [] //refresh the hullpoints array in the end of the loop
            })
          }
          //hide the convex hull
          function hideHull() {
            svg.selectAll('.hullPath').remove();
            //still need to remove the checkmark from the box on toggle
          }

          function removeText() { //remove texts tagged with 'info' class
            d3.selectAll('p.info').remove();
          }
          

///////////////////--highlight pip--//////////////////////

          var subset = data.filter(d => d.pip >= 0.1); //pip values bigger or equal to 0.1
          var subset2 = data.filter(d => d.pip > 0 && d.pip < 0.1); //pip values bigger than zero but smaller than 0.1
          //console.log(subset2)//subset 2 doesn't have anything for this dataset apparently
          function showPip() {
            svg.selectAll(".dot").data(subset).enter().append("circle").attr('r', 2).attr('class', 'pipdot').attr("cx", function(d) {
              return xScale(d.beta)+40;
            }).attr("cy", function(d) {
              return yScale(d.pval)
            }).style("fill", d => colorScale(colorValue(d))).style('stroke', 'black').style('stroke-width', 0.7).style('opacity', 1).style('pointer-events', 'none');
          }

          function showSmallPip() {
            svg.selectAll(".dot").data(subset2).enter().append("circle").attr('r', 2).attr('class', 'pipdot').attr("cx", function(d) {
              return xScale(d.beta)+40;
            }).attr("cy", function(d) {
              return yScale(d.pval)
            }).style("fill", d => colorScale(colorValue(d))).style('stroke', 'black').style('stroke-width', 0.5).style('opacity', 1).style('pointer-events', 'none');
          }
          //for significant ones
          function showPip2() {
            svg.selectAll(".dot").data(subset).enter().append("circle").attr('r', 2).attr('class', 'pipdot').attr("cx", function(d) {
              return xScale2(d.beta)+40;
            }).attr("cy", function(d) {
              if(d.pval <= 0.0000001) {
                return yScale3(d.pval)
              }
            }).style("fill", d => colorScale(colorValue(d))).style('stroke', 'black').style('stroke-width', 0.7).style('opacity', 1).style('pointer-events', 'none');
          }

          function showSmallPip2() {
            svg.selectAll(".dot")
            .data(subset2)
            .enter()
            .append("circle")
            .attr('r', 2)
            .attr('class', 'pipdot')
            .attr("cx", function(d) {
              return xScale2(d.beta)+40;
            }).attr("cy", function(d) {
              if(d.pval <= 0.0000001) {
                return yScale3(d.pval)
              }
            }).style("fill", d => colorScale(colorValue(d))).style('stroke', 'black').style('stroke-width', 0.5).style('opacity', 1).style('pointer-events', 'none');
          }

          function hidePip() {
            d3.selectAll('circle.pipdot').remove();
          }


///////////////////////////////////////////////////////
///////////////////--overview state--//////////////////
////////////////////////////////////////////////////////

          function overView() {

            resetDiv();
            clearSelections();
            hideBtn();
            hideZoomClear();
            //interactiveLabels();
            //create an svg for legend container since it's outside of the chart div
            const svg3 = d3.select('#labels-block').append('svg').attr('id', 'gLegContainer')
            //.attr("width", 500).attr("height", height * 2.1); //width and height of the inner svg, doesn't affect the div
            const legendBlockVar2 = svg3.append('g'); //another one for overView()
            //enable the enter-zoom in overview state
            //trigger a function with enter. https://stackoverflow.com/questions/40252637/keypress-trigger-a-function-if-specific-pressed
            function checkKey(e) {
              var key = e.which || e.keyCode;
              if(key === 13) {
              zooming();
              showBtn();
              hideBtns();
              removeText();
              } //on enter zoom, remove old selection text and switch button view
            } 
            document.addEventListener("keypress", checkKey);
            //remove old stuff
            svg.selectAll('.hullPath').remove();
            svg.select('rect') //avoid multiple shading rects on top of each other
              .remove();
            d3.selectAll('g.tick') //remove ticks
              .remove();
            d3.selectAll('.circleCenter') //remove circles
              .remove();
            d3.selectAll('.newCircleCenter') //remove highlights
              .remove();
            d3.selectAll('.circleBackground').remove();
            d3.selectAll('path.domain') //remove double scale lines
              .remove();
            d3.selectAll('line').remove();
            d3.selectAll('.annotation-label').remove();
            d3.selectAll('.annotation-rect').remove();
            d3.selectAll('text.axisLabel').remove();
            d3.select('g.brush').remove(); //remove old brush while changing the view
            d3.selectAll('.legendContainer') //remove old legend
              .remove();
            d3.select('#gLegContainer').remove();
            d3.selectAll('#gLegContainer3') //remove legend block from zoomm
              .remove();
            d3.selectAll('#gLegContainer4') //remove legend block from significance view
              .remove();
            labelLayer.selectAll("*") //remove legend block from significance view
              .remove();
            //Append the X Axis
            chart.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5).tickSize(-height))
              //adjust tick labels
              .selectAll('text').style('font-size', '0.5em').style('opacity', 0.5);
            //Append the Y Axis
            chart.append("g").attr("transform", `translate(0, 0)`).call(d3.axisLeft(yScale)
              .ticks(5)
              .tickSize(-width))
              //adjust tick labels
              .selectAll('text').style('font-size', '0.5em').style('opacity', 0.5).text(function(d) {
                return d === 1 ? d : d.toExponential().replace('1e-', '');
              });
            //lightly color the zero side of the x-axis
            chart.append('rect')
            .attr("height", height)
            .attr('width', xScale(0))
            .attr("fill", "lightgray")
            .attr("opacity", 0.2);
            d3.selectAll('g.tick')
            .select('line').style('stroke-width', 0.1).style('opacity', 0.5);
            chart.append('line')
            .attr("x1", 0)
            .attr("y1", yScale(0.0000001))
            .attr("x2", width)
            .attr("y2", yScale(0.0000001))
            .style("stroke", 'grey')
            .style("stroke-dasharray", ("3, 3"))
            .style("stroke-width", 0.5);
            //add labels
            chart.append("text")
            .text("-log10 p-value")
            .attr("x", 20)
            .attr("y", height / 1.8)
            .attr("transform", "translate(-150,150) rotate(-90)")
            .attr('class', 'axisLabel')
            .style('font-size', '0.4em')
            .style('font-family', 'sans-serif')
            chart.append("text")
            .attr("x", width / 2)
            .attr("y", height * 1.08)
            .attr('class', 'axisLabel')
            .style("text-anchor", "middle")
            .text("beta value")
            .style('font-size', '0.4em')
            .style('font-family', 'sans-serif')
              //set up the tooltip
            var tool_tip = d3.tip().attr("class", "d3-tip").offset([-5, 0]).html((event, d) => {
              return d.category + '<br>' + '<br>' + d.phenostring + '<br>' + '<br>' + "p-value: " + d.pval + "<br>" + "beta value: " + d.beta + '<br>' + "cases / controls: " + d.n_case + ' / ' + d.n_control + '<br>' + 'pip: ' + d.pip
            });
            svg.call(tool_tip);


///////////////////--bigger background dots--//////////////////////

            var g = svg.append('g').attr("id", "dataPoints") //make a new g element to which we append circles
              .selectAll('g').data(data).enter().append('g')
            g.append('circle')
            .attr('id', 'halo')
            .attr("cx", function(d) {
                return xScale(d.beta) + 40;
              }) //added offset to align beta values
              .attr("cy", function(d) {
                return yScale(d.pval)
              }).attr('r', d => sqrtScale(d.n_case)).style('pointer-events', 'none') //disable hover effects
              .style('opacity', function(d) {
                if(d.pval >= 0.0000001) {
                  return 'opacity', 0.1
                } else {
                  return 'opacity', 0.2
                }
              }).attr('fill', d => colorScale(colorValue(d))) //color by category


///////////////////////////--add dots--////////////////////////////

            g.append('circle').attr("cx", function(d) {
                return xScale(d.beta) + 40;
              }).attr("cy", function(d) {
                return yScale(d.pval)
              }).attr('fill', d => colorScale(colorValue(d))).attr('class', 'circleCenter').attr('r', 2).attr('stroke', 'white').attr('opacity', function(d) {
                if(d.pval >= 0.0000001) {
                  return 'opacity', 0.4
                } else {
                  return 'opacity', 1
                }
              }).attr('fill', d => colorScale(colorValue(d)))


////////////////////--hover events--////////////////////////////////

              //tooltip
              .on('mouseover.tip', tool_tip.show, function() {
                d3.select(this).transition().duration('100');
              }).on('mouseout.tip', tool_tip.hide)
              //highlight color
              .on('mouseover.color', function() {
                d3.select(this).transition().duration('200').style('opacity', 1).attr('r', d => sqrtScale(d.n_case))
              }).on('mouseout.color', function() {
                d3.select(this).transition().duration('200').style('opacity', function(d) {
                  if(d.pval >= 0.0000001) {
                    return 'opacity', 0.4
                  } else {
                    return 'opacity', 1
                  }
                }).attr('r', 2)
              })
              //add labels on click, mostly credit to Nicola
              .on("click", function(e, d) {
                var x = parseFloat(d3.select(this).attr("cx")),
                  y = parseFloat(d3.select(this).attr("cy"));
                //format the case number with a comma separator
                let format = d3.format(',');
                let formattedCases = format(d.n_case);
                const label = labelLayer.append("g").classed("chartLabel", true).style("transform", `translate(${x+10}px,${y+10}px)`);
                label.append("line")
                .attr("x1", 0)
                .attr("y1", -2.5)
                .attr("x2", -10)
                .attr("y2", -10)
                .style("stroke-width", "0.5px")
                .style("stroke", "#d3d3d3")
                label.append("text")
                .style("font-size", "5px")
                .style("font-family", "sans-serif")
                .style("cursor", "grab")
                .text(d.phenostring)
                .call(d3.drag().on("start", dragLabelStarted))
                  //I'm sure this can be worked in another way, but appended an empty string where to append the tspan: empty string allows us to always translate to the correct x-point without worrting anbout the lenght of the first string 
                label.append("text").style("font-size", "5px").style("font-family", "sans-serif").text('').call(d3.drag().on("start", dragLabelStarted))
                  //tspan in a separate line
                  .append('tspan').style("cursor", "grab").style("font-size", "5px").style("font-family", "sans-serif").attr('dy', '7px').attr('dx', '0px').text('Cases: ' + formattedCases).call(d3.drag().on("start", dragLabelStarted))
              })
              //reset labels on double-click
              .on('dblclick', function() {
                labelLayer.selectAll("*").remove();
              });


////////////////////--legends--///////////////////////////////////////

            newData = data.filter(d => d.pval <= 0.0000001)
              //categoryData = data.filter(d => d.category == 'Diseases marked as autimmune origin')
              //https://wsvincent.com/javascript-remove-duplicates-array/, this method found from the chat belove the post
            const unique = [];
            newData.map(x => unique.filter(a => a.category == x.category && a.category == x.category).length > 0 ? null : unique.push(x));
            //Initialize data
            var chartData = unique;
            //Initialize legend
            var clicked = ""
            var legendItemSize = 8;
            var legendSpacing = 20;
            var xOffset = 10;
            var yOffset = 10;
            //var labelsBlock = d3.select('#labels-block')
            var gLeg = legendBlockVar2.selectAll('g').data(chartData).enter().append('g')
            gLeg.append('circle').style('fill', d => colorScale(colorValue(d))).attr('r', legendItemSize).attr('transform', (d, i) => {
              var x = xOffset;
              var y = yOffset + (legendItemSize + legendSpacing) * i;
              return `translate(${x}, ${y})`;
            })
            gLeg.append('text').attr('class', 'label').attr('x', xOffset + legendItemSize + 5).attr('y', (d, i) => yOffset + (legendItemSize + legendSpacing) * i + 5).text(d => d.category)


            gLeg.on("mouseover.legend", function(d) {
                d3.selectAll('.newCircleCenter').remove();
                var legendText = this.textContent; //get the text of the legend in a variable
                var HighlightData = data.filter(d => d.category == legendText) //get the data objects associated with the legend
                d3.selectAll('.circleCenter').style('opacity', 0.1) //on any click set all centers to hidemode
                  //.style('pointer-events', 'none')
                  //Append new circles
                var g = svg.append('g').selectAll('g').data(HighlightData).enter().append('g')
                g.append('circle').attr("cx", function(d) {
                    return xScale(d.beta) + 40;
                  }).attr("cy", function(d) {
                    return yScale(d.pval)
                  }).attr('fill', d => colorScale(colorValue(d))).attr('class', 'newCircleCenter').attr('r', 2).attr('stroke', 'white').attr('opacity', 1).attr('fill', d => colorScale(colorValue(d)))
                  //tooltip
                  .on('mouseover.tip', tool_tip.show, function() {
                    d3.select(this).transition().duration('100');
                  }).on('mouseout.tip', tool_tip.hide)
                  //highlight color
                  .on('mouseover.color', function() {
                    d3.select(this).transition().duration('200').style('opacity', 1).attr('r', d => sqrtScale(d.n_case))
                  }).on('mouseout.color', function() {
                    d3.select(this).transition().duration('200').style('opacity', 1).attr('r', 2)
                  })
                  //add labels on click, mostly credit to Nicola
                  .on("click", function(e, d) {
                    var x = parseFloat(d3.select(this).attr("cx")),
                      y = parseFloat(d3.select(this).attr("cy"));
                    //format the case number with a comma separator
                    let format = d3.format(',');
                    let formattedCases = format(d.n_case);
                    const label = labelLayer.append("g").classed("chartLabel", true).style("transform", `translate(${x+10}px,${y+10}px)`);
                    label.append("line")
                    .attr("x1", 0)
                    .attr("y1", -2.5)
                    .attr("x2", -10)
                    .attr("y2", -10)
                    .style("stroke-width", "0.5px")
                    .style("stroke", "#d3d3d3")
                    label.append("text")
                    .style("font-size", "5px")
                    .style("font-family", "sans-serif")
                    .style("cursor", "grab")
                    .text(d.phenostring).call(d3.drag().on("start", dragLabelStarted))
                      //I'm sure this can be worked in another way, but appended an empty string where to append the tspan: empty string allows us to always translate to the correct x-point without worrting anbout the lenght of the first string 
                    label.append("text")
                    .style("font-size", "5px")
                    .style("font-family", "sans-serif")
                    .text('')
                    .call(d3.drag().on("start", dragLabelStarted))
                      //tspan in a separate line
                      .append('tspan')
                      .style("cursor", "grab")
                      .style("font-size", "5px")
                      .style("font-family", "sans-serif")
                      .attr('dy', '7px')
                      .attr('dx', '0px')
                      .text('Cases: ' + formattedCases)
                      .call(d3.drag().on("start", dragLabelStarted))
                  })
                  //reset labels on double-click
                  .on('dblclick', function() {
                    labelLayer.selectAll("*").remove();
                  });
                //highlight selected gLeg group
                d3.selectAll(gLeg).style('opacity', 0.5)
                d3.select(this).style('opacity', 1);
              }) //end of click
              //double-click anywhere on the labels block
            var labelsBlock = d3.select('#labels-block')
            labelsBlock.on('mouseout.legend', function(d) {
                //reset circlecenter opacity
                d3.selectAll('.circleCenter').style('opacity', function(d) {
                    if(d.pval >= 0.0000001) {
                      return 'opacity', 0.4
                    } else {
                      return 'opacity', 1
                    }
                  })
                  //remove highlights
                d3.selectAll('.newCircleCenter').remove();
                //legend items back to full opacity
                d3.selectAll(gLeg).style('opacity', 1);
              })
              

//////////////////////--brushing--/////////////////////////

              //help from https://peterbeshai.com/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/
              //const selection2 = [];//an empty array where we can push data
            const brush = d3.brush().extent([
              [0, 0],
              [width, height]
            ]); //stay within the chart and above the significance
            //attach the brush to the chart
            const gBrush = chart.append('g').attr('class', 'brush').call(brush);
            //column setup for the brushed data
            const table = d3.select('#info-column');
            const categoryCol = d3.select('#category');
            const phenoCol = d3.select('#phenotype');
            const pvalCol = d3.select('#pval');
            const betaCol = d3.select('#beta');
            const caseCol = d3.select('#case-control');
            //brush event
            brush.on('end', function(event, d) {
              const selection = event.selection; //the scope of the brush
              d3.selectAll('circle').each(function(d) { //go through the points
                  //condition: stay within the brush rect
                  if(yScale(d.pval) > selection[0][1] && yScale(d.pval) < selection[1][1] && xScale(d.beta) > selection[0][0] && xScale(d.beta) < selection[1][0]) {
                    selection2.push(d) //push data to the empty array
                  }
                })
                //function to remove duplicate values from the array
              function removeDuplicates(selection2) {
                return selection2.filter((value, index) => selection2.indexOf(value) === index);
              }
              console.log(removeDuplicates(selection2))
              categoryCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).attr('margin-top', function(d, i) {
                if('overflow-x' == true) {
                  return -3;
                }
              }).html(function(d) {
                return d.category;
              })
              phenoCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').attr('id', 'row').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.phenostring;
              })
              pvalCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.pval;
              })
              betaCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.beta;
              })
              caseCol.selectAll('p').data((removeDuplicates(selection2))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.n_case + ' / ' + d.n_control;
              })
            });
            //hide the convex hull
            function hideHull() {
              svg.selectAll('.hullPath').remove();
              //still need to remove the checkmark from the box on toggle
            }

            function removeText() { //remove texts tagged with 'info' class
              d3.selectAll('p.info').remove();
            }
            

///////////////////--highlight pip--//////////////////////

            var subset = data.filter(d => d.pip >= 0.1); //pip values bigger or equal to 0.1
            var subset2 = data.filter(d => d.pip > 0 && d.pip < 0.1); //pip values bigger than zero but smaller than 0.1
            //console.log(subset2)//subset 2 doesn't have anything for this dataset apparently
            function showPip() {
              svg.selectAll(".dot").data(subset).enter().append("circle").attr('r', 2).attr('class', 'pipdot').attr("cx", function(d) {
                return xScale(d.beta) + 40;
              }).attr("cy", function(d) {
                return yScale(d.pval)
              }).style("fill", d => colorScale(colorValue(d))).style('stroke', 'black').style('opacity', 1).style('pointer-events', 'none');
            }

            function showSmallPip() {
              svg.selectAll(".dot").data(subset2).enter().append("circle").attr('r', 2).attr('class', 'pipdot').attr("cx", function(d) {
                return xScale(d.beta) + 40;
              }).attr("cy", function(d) {
                return yScale(d.pval)
              }).style("fill", d => colorScale(colorValue(d))).style('stroke', 'black').style('opacity', 1).style('pointer-events', 'none');
            }
            //for significant ones
            function showPip2() {
              svg.selectAll(".dot").data(subset).enter().append("circle").attr('r', 2).attr('class', 'pipdot').attr("cx", function(d) {
                return xScale2(d.beta) + 40;
              }).attr("cy", function(d) {
                if(d.pval <= 0.0000001) {
                  return yScale3(d.pval)
                }
              }).style("fill", d => colorScale(colorValue(d))).style('stroke', 'black').style('opacity', 1).style('pointer-events', 'none');
            }

            function showSmallPip2() {
              svg.selectAll(".dot").data(subset2).enter().append("circle").attr('r', 2).attr('class', 'pipdot').attr("cx", function(d) {
                return xScale2(d.beta) + 40;
              }).attr("cy", function(d) {
                if(d.pval <= 0.0000001) {
                  return yScale3(d.pval)
                }
              }).style("fill", d => colorScale(colorValue(d))).style('stroke', 'black').style('opacity', 1).style('pointer-events', 'none');
            }

            function hidePip() {
              d3.selectAll('circle.pipdot').remove();
            }
            labelLayer.raise();
          } //end of overview


/////////////////////////////////////////////////////////////////////////
//////////////////--show significant ones function--////////////////////
/////////////////////////////////////////////////////////////////////////

          function redrawScale() { //despite the name redraw both the scales and the dots based on brush
            newData = data.filter(d => d.pval <= 0.0000001)
            removeText();
            resetDiv();
            //interactiveLabels();
            //remove old stuff
            svg.selectAll('.hullPath').remove();
            d3.selectAll('circle').remove();
            d3.selectAll('g.tick').remove();
            d3.selectAll('path.domain') //remove double scale lines
              .remove();
            d3.selectAll('line').remove();
            d3.selectAll('.annotation-label').remove();
            d3.selectAll('.annotation-rect').remove();
            /*d3.selectAll('.legendContainer')
              .remove();*/
            d3.select('#gLegContainer').remove();
            d3.select('rect').remove();
            d3.select('#gLegContainer2').remove();
            d3.select('g.brush').remove(); //remove old brush while changing the view
            //clear label layer
            labelLayer.selectAll("*").remove()
              //Append the new X Axis
            chart.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale2).ticks(5).tickSize(-height))
              //adjust tick labels
              .selectAll('text').style('font-size', '0.5em').style('opacity', 0.5);
            //Append the new Y Axis
            chart.append("g").attr("transform", `translate(0, 0)`).call(d3.axisLeft(yScale3).ticks(3).tickSize(-width))
              //adjust tick labels
              .selectAll('text').style('font-size', '0.5em').style('opacity', 0.5).text(function(d) {
                return d === 1 ? d : d.toExponential().replace('1e-', '');
              });
            //style the tick lines
            d3.selectAll('g.tick').select('line').style('stroke-width', 0.1).style('opacity', 0.5);
          //lightly color the zero side of the x-axis
          chart.append('rect')
          .attr("height", height)
          .attr('width', xScale2(0))
          .attr("fill", "lightgray")
          .attr("opacity", 0.2);

            //Append new circles
            var g = svg.append('g').selectAll('g').data(newData).enter().append('g')
            g.append('circle').attr("cx", function(d) {
                return xScale2(d.beta) + 40;
              }).attr("cy", function(d) {
                return yScale3(d.pval)
              }).attr('fill', d => colorScale(colorValue(d))).attr('class', 'circleCenter').attr('r', 2).attr('stroke', 'white').attr('opacity', 1).attr('fill', d => colorScale(colorValue(d)))
              //tooltip
              .on('mouseover.tip', tool_tip.show, function() {
                d3.select(this).transition().duration('100');
              }).on('mouseout.tip', tool_tip.hide)
              //highlight color
              .on('mouseover.color', function() {
                d3.select(this).transition().duration('200').style('opacity', 1).attr('r', d => sqrtScale(d.n_case))
              }).on('mouseout.color', function() {
                d3.select(this).transition().duration('200').style('opacity', function(d) {
                  if(d.pval >= 0.0000001) {
                    return 'opacity', 0.4
                  } else {
                    return 'opacity', 1
                  }
                }).attr('r', 2)
              })
              //add labels on click, mostly credit to Nicola
              .on("click", function(e, d) {
                var x = parseFloat(d3.select(this).attr("cx")),
                  y = parseFloat(d3.select(this).attr("cy"));
                //format the case number with a comma separator
                let format = d3.format(',');
                let formattedCases = format(d.n_case);
                const label = labelLayer.append("g").classed("chartLabel", true).style("transform", `translate(${x+10}px,${y+10}px)`);
                label.append("line").attr("x1", 0).attr("y1", -2.5).attr("x2", -10).attr("y2", -10).style("stroke-width", "0.5px").style("stroke", "#d3d3d3")
                label.append("text").style("font-size", "5px").style("font-family", "sans-serif").style("cursor", "grab").text(d.phenostring).call(d3.drag().on("start", dragLabelStarted))
                  //I'm sure this can be worked in another way, but appended an empty string where to append the tspan: empty string allows us to always translate to the correct x-point without worrting anbout the lenght of the first string 
                label.append("text").style("font-size", "5px").style("font-family", "sans-serif").text('').call(d3.drag().on("start", dragLabelStarted))
                  //tspan in a separate line
                  .append('tspan').style("cursor", "grab").style("font-size", "5px").style("font-family", "sans-serif").attr('dy', '7px').attr('dx', '0px').text('Cases: ' + formattedCases).call(d3.drag().on("start", dragLabelStarted))
              })
              //reset labels on double-click
              .on('dblclick', function() {
                labelLayer.selectAll("*").remove();
              });
            //bigger circles
            g.append('circle')
            .attr("id", "halo").attr("cx", function(d) {
                return xScale2(d.beta) + 40;
              }) //added offset to align beta values
              .attr("cy", function(d) {
                return yScale3(d.pval)
              }).attr('r', d => sqrtScale(d.n_case)).style('pointer-events', 'none') //disable hover effects
              .attr('class', 'circleBackground').style('opacity', 0.2).attr('fill', d => colorScale(colorValue(d))) //color by category
              //brushing significant ones, help from https://peterbeshai.com/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/
            const brush = d3.brush().extent([
              [0, 0],
              [width, height]
            ]); //stay within the chart and above the significance
            const gBrush = chart.append('g').attr('class', 'brush').call(brush);
            //column setup for the brushed data
            const table = d3.select('#info-column');
            const categoryCol = d3.select('#category');
            const phenoCol = d3.select('#phenotype');
            const pvalCol = d3.select('#pval');
            const betaCol = d3.select('#beta');
            const caseCol = d3.select('#case-control');


//////////////////--legends--//////////////////////////////////////////
            //significant ones label block
            //https://wsvincent.com/javascript-remove-duplicates-array/, this method found from the chat belove the post
            const unique = [];
            newData.map(x => unique.filter(a => a.category == x.category && a.category == x.category).length > 0 ? null : unique.push(x));
            console.log(unique);
            //Initialize data
            var chartData = unique;
            //Initialize legend
            var legendItemSize = 8;
            var legendSpacing = 20;
            var xOffset = 10;
            var yOffset = 10;
            //create an svg for legend container since it's outside of the chart div
            const svg5 = d3.select('#labels-block').append('svg').attr('id', 'gLegContainer')
            //.attr("width", 500).attr("height", height * 2.1); //width and height of the inner svg, doesn't affect the div
            const legendBlockVar4 = svg5.append('g'); //another one for zooming()
            var gLeg = legendBlockVar4.selectAll('g').data(chartData).enter().append('g')
            gLeg.append('circle').style('fill', d => colorScale(colorValue(d))).attr('r', legendItemSize).attr('transform', (d, i) => {
              var x = xOffset;
              var y = yOffset + (legendItemSize + legendSpacing) * i;
              return `translate(${x}, ${y})`;
            })
            gLeg.append('text').attr('class', 'label').attr('x', xOffset + legendItemSize + 5).attr('y', (d, i) => yOffset + (legendItemSize + legendSpacing) * i + 5).text(d => d.category)
            gLeg.on("mouseover.legend", function(d) {
                d3.selectAll('.newCircleCenter').remove();
                var legendText = this.textContent; //get the text of the legend in a variable
                var HighlightData = newData.filter(d => d.category == legendText) //get the data objects associated with the legend
                d3.selectAll('.circleCenter').style('opacity', 0.1) //on any click set all centers to hidemode
                  //.style('pointer-events', 'none')
                  //Append new circles
                var g = svg.append('g').selectAll('g').data(HighlightData).enter().append('g')
                g.append('circle').attr("cx", function(d) {
                    return xScale2(d.beta) + 40;
                  }).attr("cy", function(d) {
                    return yScale3(d.pval)
                  }).attr('fill', d => colorScale(colorValue(d))).attr('class', 'newCircleCenter').attr('r', 2).attr('stroke', 'white').attr('opacity', 1).attr('fill', d => colorScale(colorValue(d)))
                  //tooltip
                  .on('mouseover.tip', tool_tip.show, function() {
                    d3.select(this).transition().duration('100');
                  }).on('mouseout.tip', tool_tip.hide)
                  //highlight color
                  .on('mouseover.color', function() {
                    d3.select(this).transition().duration('200').style('opacity', 1).attr('r', d => sqrtScale(d.n_case))
                  }).on('mouseout.color', function() {
                    d3.select(this).transition().duration('200').style('opacity', 1).attr('r', 2)
                  })
                  //add labels on click, mostly credit to Nicola
                  .on("click", function(e, d) {
                    var x = parseFloat(d3.select(this).attr("cx")),
                      y = parseFloat(d3.select(this).attr("cy"));
                    //format the case number with a comma separator
                    let format = d3.format(',');
                    let formattedCases = format(d.n_case);
                    const label = labelLayer.append("g").classed("chartLabel", true).style("transform", `translate(${x+10}px,${y+10}px)`);
                    label.append("line").attr("x1", 0).attr("y1", -2.5).attr("x2", -10).attr("y2", -10).style("stroke-width", "0.5px").style("stroke", "#d3d3d3")
                    label.append("text").style("font-size", "5px").style("font-family", "sans-serif").style("cursor", "grab").text(d.phenostring).call(d3.drag().on("start", dragLabelStarted))
                      //I'm sure this can be worked in another way, but appended an empty string where to append the tspan: empty string allows us to always translate to the correct x-point without worrting anbout the lenght of the first string 
                    label.append("text").style("font-size", "5px").style("font-family", "sans-serif").text('').call(d3.drag().on("start", dragLabelStarted))
                      //tspan in a separate line
                      .append('tspan').style("cursor", "grab").style("font-size", "5px").style("font-family", "sans-serif").attr('dy', '7px').attr('dx', '0px').text('Cases: ' + formattedCases).call(d3.drag().on("start", dragLabelStarted))
                  })
                  //reset labels on double-click
                  .on('dblclick', function() {
                    labelLayer.selectAll("*").remove();
                  });
                //highlight selected gLeg group
                d3.selectAll(gLeg).style('opacity', 0.5)
                d3.select(this).style('opacity', 1);
              }) //end of click
              //double-click anywhere on the labels block
            var labelsBlock = d3.select('#labels-block')
            labelsBlock.on('mouseout.legend', function(d) {
                //reset circlecenter opacity
                d3.selectAll('.circleCenter').style('opacity', function(d) {
                    if(d.pval >= 0.0000001) {
                      return 'opacity', 0.4
                    } else {
                      return 'opacity', 1
                    }
                  })
                  //remove highlights
                d3.selectAll('.newCircleCenter').remove();
                //legend items back to full opacity
                d3.selectAll(gLeg).style('opacity', 1);
              })


////////////////////////////////////////////////////////////////////
            //brush event
            brush.on('end', function(event, d) {
              const selection = event.selection; //the scope of the brush
              d3.selectAll('circle').each(function(d) { //go through the points
                  //condition: stay within the brush rect
                  if(yScale3(d.pval) > selection[0][1] && yScale3(d.pval) < selection[1][1] && xScale2(d.beta) > selection[0][0] && xScale2(d.beta) < selection[1][0]) {
                    selection3.push(d) //push data to the empty array
                  }
                })
                //function to remove duplicate values from the array
              function removeDuplicates2(selection2) {
                return selection3.filter((value, index) => selection3.indexOf(value) === index);
              }
              categoryCol.selectAll('p').data((removeDuplicates2(selection3))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).attr('margin-top', function(d, i) {
                if('overflow-x' == true) {
                  return -3;
                }
              }).html(function(d) {
                return d.category;
              })
              phenoCol.selectAll('p').data((removeDuplicates2(selection3))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').attr('id', 'row').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.phenostring;
              })
              pvalCol.selectAll('p').data((removeDuplicates2(selection3))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.pval;
              })
              betaCol.selectAll('p').data((removeDuplicates2(selection3))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.beta;
              })
              caseCol.selectAll('p').data((removeDuplicates2(selection3))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.n_case + ' / ' + d.n_control;
              })
            });

            function removeText() { //remove texts tagged with 'info' class
              d3.selectAll('p.info').remove();
            }
            labelLayer.raise();
          } //end of redraw


/////////////////////////////////////////////////////
//////////////////--simple zoom----//////////////////
////////////////////////////////////////////////////

          function zooming() {
            showZoomClear();
            resetDiv();//reset the legend block
            //remove old stuff
            svg.selectAll('.hullPath') //remove hull if there is one
              .remove();
            svg.selectAll('rect').remove();
            d3.selectAll('circle') //remove old circles
              .remove();
            d3.selectAll('g.tick') //remove old ticks from old scales
              .remove();
            d3.selectAll('path.domain') //remove double scale lines
              .remove();
            d3.select('g.brush') //remove old brush square
              .remove();
            //remove annotations
            d3.selectAll('.annotation-label').remove();
            d3.selectAll('.annotation-rect').remove();
            d3.selectAll('.legendContainer') //remove old legends
              .remove();
            d3.selectAll('#gLegContainer').remove();
            d3.selectAll('#gLegContainer2').remove();
            d3.selectAll('#gLegContainer3').remove();
            d3.selectAll('line').remove();
            //clear label layer
            labelLayer.selectAll("*").remove()
            //create an svg for legend container since it's outside of the chart div
            const svg4 = d3.select('#labels-block').append('svg').attr('id', 'gLegContainer')
            //.attr("width", 500).attr("height", height * 2.1); //width and height of the inner svg, doesn't affect the div
            const legendBlockVar3 = svg4.append('g'); //another one for zooming()
            //get min and max p values from selection for zooming
            var pMax2 = d3.max(selection2, function(d) {
              return d.pval;
            });
            var pMin2 = d3.min(selection2, function(d) {
              return d.pval;
            })
            var yScale4 = d3.scaleLog().domain([pMin2 - (pMin2 / 1.001), pMax2 + (pMax2 * 2)]).range([0, height]).nice();
            //get min and max beta from selection for zooming
            var betaMax3 = d3.max(selection2, function(d) {
              return d.beta;
            });
            var betaMin3 = d3.min(selection2, function(d) {
              return d.beta;
            });
            var xScale3 = d3.scaleLinear()
              //.domain([betaMin3-(betaMax3),betaMax3+(betaMin3*(-1))])
              .domain([betaMin3-0.1, betaMax3+0.1]).range([0, width]);
            //Append the new X Axis
            chart.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale3).ticks(5, '.2f').tickSize(-height))
              //adjust tick labels
              .selectAll('text').style('font-size', '0.5em').style('opacity', 0.5);
            //Append the new Y Axis
            chart.append("g").attr("transform", `translate(0, 0)`).call(d3.axisLeft(yScale4).tickSize(-width).tickArguments([5, ".0f"]))
              //adjust tick labels
              .selectAll('text').style('font-size', '0.5em').style('opacity', 0.5).text(function(d) {
                return d === 1 ? d : d.toExponential().replace('1e-', '');
              });
            //style the tick lines
            d3.selectAll('g.tick').select('line').style('stroke-width', 0.1).style('opacity', 0.5);
            //lightly color the zero side of the x-axis
          chart.append('rect')
          .attr("height", height)
          .attr('width', xScale3(0))
          .attr("fill", "lightgray")
          .attr("opacity", 0.2);

            var g = svg.append('g') //make a new g element to which we append circles
              .selectAll('g').data(selection2).enter().append('g')
            g.append('circle').attr("cx", function(d) {
                return xScale3(d.beta) + 40;
              }).attr("cy", function(d) {
                return yScale4(d.pval)
              }).attr('fill', d => colorScale(colorValue(d))).attr('class', 'circleCenter').attr('r', 2).attr('stroke', 'white').attr('opacity', function(d) {
                if(d.pval >= 0.0000001) {
                  return 'opacity', 0.4
                } else {
                  return 'opacity', 1
                }
              }).attr('fill', d => colorScale(colorValue(d)))
              //tooltip
              .on('mouseover.tip', tool_tip.show, function() {
                d3.select(this).transition().duration('100');
              }).on('mouseout.tip', tool_tip.hide)
              //highlight color
              .on('mouseover.color', function() {
                d3.select(this).transition().duration('200').style('opacity', 1).attr('r', d => sqrtScale(d.n_case))
              }).on('mouseout.color', function() {
                d3.select(this).transition().duration('200').style('opacity', function(d) {
                  if(d.pval >= 0.0000001) {
                    return 'opacity', 0.4
                  } else {
                    return 'opacity', 1
                  }
                }).attr('r', 2)
              })
              //add labels on click, mostly credit to Nicola
              .on("click", function(e, d) {
                var x = parseFloat(d3.select(this).attr("cx")),
                  y = parseFloat(d3.select(this).attr("cy"));
                //format the case number with a comma separator
                let format = d3.format(',');
                let formattedCases = format(d.n_case);
                const label = labelLayer.append("g").classed("chartLabel", true).style("transform", `translate(${x+10}px,${y+10}px)`);
                label.append("line")
                .attr("x1", 0)
                .attr("y1", -2.5)
                .attr("x2", -10)
                .attr("y2", -10)
                .style("stroke-width", "0.5px")
                .style("stroke", "#d3d3d3")
                label.append("text")
                .style("font-size", "5px")
                .style("font-family", "sans-serif")
                .style("cursor", "grab")
                .text(d.phenostring)
                .call(d3.drag().on("start", dragLabelStarted))
                  //I'm sure this can be worked in another way, but appended an empty string where to append the tspan: empty string allows us to always translate to the correct x-point without worrting anbout the lenght of the first string 
                label.append("text").style("font-size", "5px").style("font-family", "sans-serif").text('').call(d3.drag().on("start", dragLabelStarted))
                  //tspan in a separate line
                  .append('tspan').style("cursor", "grab").style("font-size", "5px").style("font-family", "sans-serif").attr('dy', '7px').attr('dx', '0px').text('Cases: ' + formattedCases).call(d3.drag().on("start", dragLabelStarted))
              })
              //reset labels on double-click
              .on('dblclick', function() {
                labelLayer.selectAll("*").remove();
              });
            //bigger background dots
            g.append('circle')
            .attr('id', 'halo')
            .attr("cx", function(d) {
                return xScale3(d.beta) + 40;
              }) //added offset to align beta values
              .attr("cy", function(d) {
                return yScale4(d.pval)
              }).attr('r', d => sqrtScale(d.n_case)).style('pointer-events', 'none') //disable hover effects
              .attr('class', 'circleBackground').style('opacity', function(d) {
                if(d.pval >= 0.0000001) {
                  return 'opacity', 0.1
                } else {
                  return 'opacity', 0.2
                }
              }).attr('fill', d => colorScale(colorValue(d))) //color by category
            g.append('line').attr("x1", 40).attr("y1", function(d) {
              if(d.pval > 0.0000001) {
                return yScale4(0.0000001)
              }
            }).attr("x2", width + 40).attr("y2", function(d) {
              if(d.pval > 0.0000001) {
                return yScale4(0.0000001)
              }
            }).style("stroke", 'grey').style("stroke-dasharray", ("3, 3")).style("stroke-width", 0.3);
            //help from https://peterbeshai.com/blog/2016-12-03-brushing-in-scatterplots-with-d3-and-quadtrees/
            const brush = d3.brush().extent([
              [0, 0],
              [width, height]
            ]); //stay within the chart
            //attach the brush to the chart
            const gBrush = chart.append('g').attr('class', 'brush').call(brush);
            ////////////////////////////////////////////////////////////
            //https://wsvincent.com/javascript-remove-duplicates-array/, this method found from the chat belove the post
            const unique = [];
            selection2.map(x => unique.filter(a => a.category == x.category && a.category == x.category).length > 0 ? null : unique.push(x));
            //Initialize data
            var chartData = unique;
            //Initialize legend
            var legendItemSize = 8;
            var legendSpacing = 20;
            var xOffset = 10;
            var yOffset = 10;
            var gLeg = legendBlockVar3.selectAll('g').data(chartData).enter().append('g')
            gLeg.append('circle').style('fill', d => colorScale(colorValue(d))).attr('r', legendItemSize).attr('transform', (d, i) => {
              var x = xOffset;
              var y = yOffset + (legendItemSize + legendSpacing) * i;
              return `translate(${x}, ${y})`;
            })
            gLeg.append('text').attr('class', 'label').attr('x', xOffset + legendItemSize + 5).attr('y', (d, i) => yOffset + (legendItemSize + legendSpacing) * i + 5).text(d => d.category)
              ////////////////////////////////////////////////////////////////////
              //attaching click to the legend text for now
            gLeg.on("mouseover.legend", function(d) {
                d3.selectAll('.newCircleCenter').remove();
                var legendText = this.textContent; //get the text of the legend in a variable
                var HighlightData = selection2.filter(d => d.category == legendText) //get the data objects associated with the legend
                d3.selectAll('.circleCenter').style('opacity', 0.1) //on any click set all centers to hidemode
                  //.style('pointer-events', 'none')
                  //Append new circles
                var g = svg.append('g').selectAll('g').data(HighlightData).enter().append('g')
                g.append('circle').attr("cx", function(d) {
                    return xScale3(d.beta) + 40;
                  }).attr("cy", function(d) {
                    return yScale4(d.pval)
                  }).attr('fill', d => colorScale(colorValue(d))).attr('class', 'newCircleCenter').attr('r', 2).attr('stroke', 'white').attr('opacity', 1).attr('fill', d => colorScale(colorValue(d)))
                  //tooltip
                  .on('mouseover.tip', tool_tip.show, function() {
                    d3.select(this).transition().duration('100');
                  }).on('mouseout.tip', tool_tip.hide)
                  //highlight color
                  .on('mouseover.color', function() {
                    d3.select(this).transition().duration('200').style('opacity', 1).attr('r', d => sqrtScale(d.n_case))
                  }).on('mouseout.color', function() {
                    d3.select(this).transition().duration('200').style('opacity', 1).attr('r', 2)
                  })
                  //highlight selected gLeg group
                d3.selectAll(gLeg).style('opacity', 0.5)
                d3.select(this).style('opacity', 1);
              }) //end of click
              //double-click anywhere on the labels block
            var labelsBlock = d3.select('#labels-block')
            labelsBlock.on('mouseout.legend', function(d) {
                //reset circlecenter opacity
                d3.selectAll('.circleCenter').style('opacity', function(d) {
                    if(d.pval >= 0.0000001) {
                      return 'opacity', 0.4
                    } else {
                      return 'opacity', 1
                    }
                  })
                  //remove highlights
                d3.selectAll('.newCircleCenter').remove();
                //legend items back to full opacity
                d3.selectAll(gLeg).style('opacity', 1);
              })
              //column setup for the brushed data
            const categoryCol = d3.select('#category');
            const phenoCol = d3.select('#phenotype');
            const pvalCol = d3.select('#pval');
            const betaCol = d3.select('#beta');
            const caseCol = d3.select('#case-control');
            //brush event
            brush.on('end', function(event, d) {
              const selection = event.selection; //the scope of the brush
              d3.selectAll('circle').each(function(d) { //go through the points
                  if(yScale4(d.pval) > selection[0][1] && yScale4(d.pval) < selection[1][1] && xScale3(d.beta) > selection[0][0] && xScale3(d.beta) < selection[1][0]) {
                    selection4.push(d) //push data to the empty array
                  }
                })
                //function to remove duplicate values from the array
              function removeDuplicates3(selection4) {
                return selection4.filter((value, index) => selection4.indexOf(value) === index);
              }
              console.log(removeDuplicates3(selection4));
              /*new values to table from selection 4*/
              categoryCol.selectAll('p').data((removeDuplicates3(selection4))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).attr('margin-top', function(d, i) {
                if('overflow-x' == true) {
                  return -3;
                }
              }).html(function(d) {
                return d.category;
              })
              phenoCol.selectAll('p').data((removeDuplicates3(selection4))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').attr('id', 'row').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.phenostring;
              })
              pvalCol.selectAll('p').data((removeDuplicates3(selection4))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.pval;
              })
              betaCol.selectAll('p').data((removeDuplicates3(selection4))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.beta;
              })
              caseCol.selectAll('p').data((removeDuplicates3(selection4))).enter().append('div').attr('data-simplebar', 'init').style('overflow-x', 'auto').append('p').attr('class', 'info').attr('x', 10).attr('y', function(d, i) {
                return i * 12;
              }).html(function(d) {
                return d.n_case + ' / ' + d.n_control;
              })
            })
            labelLayer.raise();
          } //end of zoom
          //hide the convex hull
          function hideHull() {
            svg.selectAll('.hullPath').remove();
          }

          function removeBrush2() { //remove brush selection
            selection3.length = 0;
          }

          function removeBrush3() { //remove brush selection
            selection4.length = 0;
          }
          const labelLayer = svg.append('g').attr("id", "labelLayer")

          function dragLabelStarted(event) {
            const label = d3.select(this.parentNode);
            event.on("drag", dragged).on("end", ended);

            function dragged(event) {
              label.select("line").raise().attr("x1", event.x).attr("y1", event.y - 2.5);
              label.select("text").raise().attr("x", event.x).attr("y", event.y).style("cursor", "grabbing");
            }

            function ended() {
              label.select("text").style("cursor", "grab");
            }
          }
        } 
      </script>
    </body>
  </html>